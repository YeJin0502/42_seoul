FROM debian:buster
MAINTAINER gmoon <gmoon@student.42seoul.kr>

WORKDIR /tmp
RUN apt update
RUN apt install -y nginx mariadb-server php-fpm php-mysql; \
	apt install -y curl php-curl php-gd php-intl php-mbstring php-soap php-xml php-xmlrpc php-zip; \
	apt install -y wget php-json php-mbstring php-zip php-gd
RUN curl -LO https://wordpress.org/latest.tar.gz
RUN wget https://files.phpmyadmin.net/phpMyAdmin/4.9.0.1/phpMyAdmin-4.9.0.1-all-languages.tar.gz

# LEMP
ADD srcs/default /etc/nginx/sites-available/default
ADD srcs/info.php /var/www/html/info.php

# wordpress
RUN tar xzvf latest.tar.gz; \
	cp -a /tmp/wordpress/. /var/www/html
ADD srcs/wp-config.php /var/www/html/wp-config.php
RUN service mysql start; \
	echo "CREATE DATABASE wordpress DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci;" | mysql; \
	echo "GRANT ALL ON wordpress.* TO 'wordpress_user'@'localhost' IDENTIFIED BY 'password';" | mysql; \
	echo "FLUSH PRIVILEGES;" | mysql

# phpmyadmin
RUN tar xzvf phpMyAdmin-4.9.0.1-all-languages.tar.gz; \
	mv phpMyAdmin-4.9.0.1-all-languages /usr/share/phpmyadmin
ADD srcs/config.inc.php /usr/share/phpmyadmin/config.inc.php
# RUN service mysql start; \
# 	mysql < /usr/share/phpmyadmin/sql/create_tables.sql; \
# 	echo "GRANT ALL PRIVILEGES ON phpmyadmin.* TO 'pma'@'localhost' IDENTIFIED BY 'password';" | mysql; \
# 	echo "FLUSH PRIVILEGES;" | mysql
RUN mkdir /usr/share/phpmyadmin/tmp; \
	chmod 777 /usr/share/phpmyadmin/tmp; \
	chown -R www-data:www-data /usr/share/phpmyadmin
# RUN service mysql start; \
# 	echo "CREATE DATABASE app_db;" | mysql; \
# 	echo "GRANT ALL PRIVILEGES ON app_db.* TO 'app_user'@'localhost' IDENTIFIED BY 'password';" | mysql; \
# 	echo "FLUSH PRIVILEGES;" | mysql

EXPOSE 80

# WORKDIR /etc/nginx/sites-available/
CMD service mysql start; \
	/etc/init.d/php7.3-fpm start; \
	nginx -g 'daemon off;'
### CMD와 entrypoint의 차이는?
### CMD에서 이거 안해주면 바로 꺼지는 이유는?
