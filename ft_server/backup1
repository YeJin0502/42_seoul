FROM debian:buster
MAINTAINER gmoon <gmoon@student.42seoul.kr>

WORKDIR /tmp
RUN apt update
RUN apt install -y nginx mariadb-server php-fpm php-mysql; \
	apt install -y curl php-curl php-gd php-intl php-mbstring php-soap php-xml php-xmlrpc php-zip; \
	apt install -y wget php-json php-mbstring php-zip php-gd
RUN curl -LO https://wordpress.org/latest.tar.gz
RUN wget https://files.phpmyadmin.net/phpMyAdmin/4.9.0.1/phpMyAdmin-4.9.0.1-all-languages.tar.gz

# LEMP
# RUN echo "\ndaemon off;" >> /etc/nginx/nginx.conf
	### 이거 해줘야하나? 무슨 뜻?
# RUN chown -R www-data:www-data /var/lib/nginx
	### 위에꺼는 왜 해주는거지?
ADD srcs/default /etc/nginx/sites-available/default
ADD srcs/info.php /var/www/html/info.php
	### <?php어쩌고?>는 무슨 뜻일까? 그리고 마지막에 ?> 안해줘도 되나?

# wordpress
ADD srcs/*.sql /tmp/
	### 마지막에 / 붙이고 안붙이고 이런게 헷갈린다. 터미널에서 테스트해볼 것...
RUN tar xzvf latest.tar.gz
RUN cp -a /tmp/wordpress/. /var/www/html
# RUN chown -R www-data:www-data /var/www/html
ADD srcs/wp-config.php /var/www/html/wp-config.php

# phpmyadmin
RUN tar xvf phpMyAdmin-4.9.0.1-all-languages.tar.gz
RUN mv phpMyAdmin-4.9.0.1-all-languages/ /usr/share/phpmyadmin
ADD srcs/config.inc.php /usr/share/phpmyadmin/config.inc.php
# RUN service mysql restart; \
# 	mysql < /usr/share/phpmyadmin/sql/create_tables.sql; \
# 	echo "GRANT SELECT, INSERT, UPDATE, DELETE ON phpmyadmin.* TO 'pma'@'localhost' IDENTIFIED BY 'password';" | mysql; \
# 	echo "FLUSH PRIVILEGES;" | mysql
RUN mkdir -p /var/lib/phpmyadmin/tmp
RUN chmod 777 /var/lib/phpmyadmin/tmp
RUN chown -R www-data:www-data /var/lib/phpmyadmin
RUN ln -s /usr/share/phpmyadmin /var/www/html/phpmyadmin

# RUN chown -R mysql:mysql /var/lib/mysql
RUN service mysql start; \
	mysql < /tmp/wordpress.sql

EXPOSE 80

# WORKDIR /etc/nginx/sites-available/
CMD service mysql start; \
	/etc/init.d/php7.3-fpm start; \
	nginx -g 'daemon off;'
### CMD와 entrypoint의 차이는?
### CMD에서 이거 안해주면 바로 꺼지는 이유는?
